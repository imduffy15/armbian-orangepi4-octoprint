version: '3.8'

services:
  portainer:
    image: portainer/portainer-ce:latest
    container_name: portainer
    restart: always
    ports:
      - "9000:9000"
      - "9443:9443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer_data:/data

  octoprint:
    image: octoprint/octoprint:latest
    container_name: octoprint
    restart: always
    ports:
      - "5000:5000"
    # Comprehensive device access for USB, GPIO, I2C, SPI
    devices:
      # USB Serial devices (3D printer communication)
      - /dev/ttyUSB0:/dev/ttyUSB0
      - /dev/ttyUSB1:/dev/ttyUSB1
      - /dev/ttyACM0:/dev/ttyACM0
      - /dev/ttyACM1:/dev/ttyACM1
      # Video devices (webcams)
      - /dev/video0:/dev/video0
      - /dev/video1:/dev/video1
      # GPIO access
      - /dev/gpiomem:/dev/gpiomem
      - /dev/gpiochip0:/dev/gpiochip0
      - /dev/gpiochip1:/dev/gpiochip1
      # I2C devices (displays, sensors)
      - /dev/i2c-0:/dev/i2c-0
      - /dev/i2c-1:/dev/i2c-1
      - /dev/i2c-2:/dev/i2c-2
      # SPI devices
      - /dev/spidev0.0:/dev/spidev0.0
      - /dev/spidev0.1:/dev/spidev0.1
    volumes:
      - octoprint_data:/octoprint
      - /dev:/dev  # Full device access
    # Add user to necessary groups for device access
    group_add:
      - dialout   # Serial port access
      - video     # Video device access
      - gpio      # GPIO access
      - i2c       # I2C access
      - spi       # SPI access
    # Required capabilities for hardware access
    cap_add:
      - SYS_RAWIO  # Raw I/O for GPIO/I2C/SPI
      - NET_ADMIN  # Network administration (for some plugins)
    environment:
      - ENABLE_MJPG_STREAMER=true
      - CAMERA_DEV=/dev/video0

volumes:
  portainer_data:
  octoprint_data:
